---
# Circuit Breaker for Core Service
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: circuit-breaker-core
  namespace: shop
spec:
  workloadSelector:
    labels:
      app: core-service
  configPatches:
    - applyTo: CLUSTER
      match:
        context: SIDECAR_OUTBOUND
        cluster:
          name: "outbound|8081||oms-service.shop.svc.cluster.local"
      patch:
        operation: MERGE
        value:
          circuit_breakers:
            thresholds:
              - priority: DEFAULT
                max_connections: 100
                max_pending_requests: 100
                max_requests: 1000
                max_retries: 3
              - priority: HIGH
                max_connections: 200
                max_pending_requests: 200
                max_requests: 2000
                max_retries: 5
          outlier_detection:
            consecutive_5xx: 5
            interval: 10s
            base_ejection_time: 30s
            max_ejection_percent: 50
            consecutive_gateway_failure: 5
            enforcing_consecutive_5xx: 100
            enforcing_consecutive_gateway_failure: 100
---
# Retry Policy for External Services
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: retry-policy
  namespace: shop
spec:
  workloadSelector:
    labels:
      app: core-service
  configPatches:
    - applyTo: HTTP_ROUTE
      match:
        context: SIDECAR_OUTBOUND
      patch:
        operation: MERGE
        value:
          route:
            retry_policy:
              retry_on: "connect-failure,refused-stream,unavailable,cancelled,retriable-4xx,reset,503"
              num_retries: 3
              per_try_timeout: 10s
              retry_back_off:
                base_interval: 0.25s
                max_interval: 1s
---
# Timeout Configuration
apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: timeout-config
  namespace: shop
spec:
  workloadSelector:
    labels:
      app: core-service
  configPatches:
    - applyTo: HTTP_ROUTE
      match:
        context: SIDECAR_OUTBOUND
        routeConfiguration:
          vhost:
            name: "oms-service.shop.svc.cluster.local:8081"
      patch:
        operation: MERGE
        value:
          route:
            timeout: 30s
            idle_timeout: 60s

    - applyTo: HTTP_ROUTE
      match:
        context: SIDECAR_OUTBOUND
        routeConfiguration:
          vhost:
            name: "crm-service.shop.svc.cluster.local:8082"
      patch:
        operation: MERGE
        value:
          route:
            timeout: 15s
            idle_timeout: 30s

    - applyTo: HTTP_ROUTE
      match:
        context: SIDECAR_OUTBOUND
        routeConfiguration:
          vhost:
            name: "notification-service.shop.svc.cluster.local:8083"
      patch:
        operation: MERGE
        value:
          route:
            timeout: 5s
            idle_timeout: 10s
---
# Fault Injection for Testing (disabled by default)
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: core-service-fault-injection
  namespace: shop
  annotations:
    description: "Fault injection for chaos testing - disabled by default"
spec:
  hosts:
    - core-service
  http:
    - match:
        - headers:
            x-chaos-test:
              exact: "delay"
      fault:
        delay:
          percentage:
            value: 100
          fixedDelay: 5s
      route:
        - destination:
            host: core-service
            subset: stable

    - match:
        - headers:
            x-chaos-test:
              exact: "abort"
      fault:
        abort:
          percentage:
            value: 100
          httpStatus: 503
      route:
        - destination:
            host: core-service
            subset: stable

    # Normal traffic (no fault injection)
    - route:
        - destination:
            host: core-service
            subset: stable
