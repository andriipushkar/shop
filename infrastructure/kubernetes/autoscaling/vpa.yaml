# Vertical Pod Autoscaler configurations for Shop Platform
# VPA automatically adjusts CPU and memory requests based on usage
# Install VPA: kubectl apply -f https://github.com/kubernetes/autoscaler/releases/latest/download/vpa-v1-crd.yaml
---
# Core API Service VPA
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: core-service-vpa
  namespace: shop
  labels:
    app: core-service
    component: autoscaling
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: core-service
  updatePolicy:
    updateMode: "Auto"  # Auto, Recreate, Initial, Off
  resourcePolicy:
    containerPolicies:
      - containerName: core-service
        minAllowed:
          cpu: 100m
          memory: 128Mi
        maxAllowed:
          cpu: 2000m
          memory: 2Gi
        controlledResources: ["cpu", "memory"]
        controlledValues: RequestsAndLimits
---
# OMS Service VPA
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: oms-service-vpa
  namespace: shop
  labels:
    app: oms-service
    component: autoscaling
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: oms-service
  updatePolicy:
    updateMode: "Auto"
  resourcePolicy:
    containerPolicies:
      - containerName: oms-service
        minAllowed:
          cpu: 100m
          memory: 128Mi
        maxAllowed:
          cpu: 2000m
          memory: 2Gi
        controlledResources: ["cpu", "memory"]
---
# CRM Service VPA
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: crm-service-vpa
  namespace: shop
  labels:
    app: crm-service
    component: autoscaling
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: crm-service
  updatePolicy:
    updateMode: "Auto"
  resourcePolicy:
    containerPolicies:
      - containerName: crm-service
        minAllowed:
          cpu: 50m
          memory: 64Mi
        maxAllowed:
          cpu: 1000m
          memory: 1Gi
---
# Notification Service VPA
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: notification-service-vpa
  namespace: shop
  labels:
    app: notification-service
    component: autoscaling
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: notification-service
  updatePolicy:
    updateMode: "Auto"
  resourcePolicy:
    containerPolicies:
      - containerName: notification-service
        minAllowed:
          cpu: 50m
          memory: 64Mi
        maxAllowed:
          cpu: 1000m
          memory: 1Gi
---
# Storefront VPA
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: storefront-vpa
  namespace: shop
  labels:
    app: storefront
    component: autoscaling
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: storefront
  updatePolicy:
    updateMode: "Auto"
  resourcePolicy:
    containerPolicies:
      - containerName: storefront
        minAllowed:
          cpu: 100m
          memory: 128Mi
        maxAllowed:
          cpu: 1500m
          memory: 1536Mi
---
# Admin Panel VPA
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: admin-panel-vpa
  namespace: shop
  labels:
    app: admin-panel
    component: autoscaling
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: admin-panel
  updatePolicy:
    updateMode: "Auto"
  resourcePolicy:
    containerPolicies:
      - containerName: admin-panel
        minAllowed:
          cpu: 50m
          memory: 64Mi
        maxAllowed:
          cpu: 1000m
          memory: 1Gi
---
# Analytics ETL VPA
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: analytics-etl-vpa
  namespace: shop
  labels:
    app: analytics-etl
    component: autoscaling
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: analytics-etl
  updatePolicy:
    updateMode: "Auto"
  resourcePolicy:
    containerPolicies:
      - containerName: analytics-etl
        minAllowed:
          cpu: 100m
          memory: 256Mi
        maxAllowed:
          cpu: 2000m
          memory: 4Gi  # ETL may need more memory for batch processing
---
# PodDisruptionBudget for critical services
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: core-service-pdb
  namespace: shop
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: core-service
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: oms-service-pdb
  namespace: shop
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: oms-service
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: storefront-pdb
  namespace: shop
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: storefront
---
# Resource Quota for namespace
apiVersion: v1
kind: ResourceQuota
metadata:
  name: shop-resource-quota
  namespace: shop
spec:
  hard:
    requests.cpu: "20"
    requests.memory: 40Gi
    limits.cpu: "40"
    limits.memory: 80Gi
    pods: "100"
    services: "20"
    persistentvolumeclaims: "20"
---
# Limit Range for default container limits
apiVersion: v1
kind: LimitRange
metadata:
  name: shop-limit-range
  namespace: shop
spec:
  limits:
    - type: Container
      default:
        cpu: 500m
        memory: 512Mi
      defaultRequest:
        cpu: 100m
        memory: 128Mi
      min:
        cpu: 50m
        memory: 64Mi
      max:
        cpu: 4000m
        memory: 8Gi
    - type: PersistentVolumeClaim
      min:
        storage: 1Gi
      max:
        storage: 100Gi
