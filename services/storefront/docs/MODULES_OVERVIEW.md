# Огляд модулів системи

Цей документ містить огляд всіх нових модулів та їх архітектури.

## Зміст

- [Архітектура системи](#архітектура-системи)
- [Модулі](#модулі)
  - [Фіскалізація (ПРРО)](#фіскалізація-прро)
  - [B2B Продажі](#b2b-продажі)
  - [Dropshipping / Supplier API](#dropshipping--supplier-api)
  - [Апаратне забезпечення](#апаратне-забезпечення)
  - [AI Репрайсинг](#ai-репрайсинг)
  - [AI Прогнозування попиту](#ai-прогнозування-попиту)
  - [Warehouse Management (Go)](#warehouse-management-go)
- [Інтеграційні точки](#інтеграційні-точки)
- [Залежності](#залежності)

## Архітектура системи

```
┌─────────────────────────────────────────────────────────────────┐
│                         Frontend (Next.js)                       │
│                   /admin /pos /supplier /b2b                     │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            │ REST API / WebSocket
                            │
┌───────────────────────────┴─────────────────────────────────────┐
│                      API Layer (Next.js)                         │
│  /api/admin/fiscal  /api/b2b  /api/supplier  /api/hardware      │
│  /api/ai            /api/admin/warehouse                         │
└───┬───────────┬───────────┬───────────┬──────────┬──────────────┘
    │           │           │           │          │
    ▼           ▼           ▼           ▼          ▼
┌─────────┐ ┌──────┐  ┌─────────┐ ┌────────┐ ┌──────────┐
│  ПРРО   │ │ B2B  │  │Supplier │ │Hardware│ │   AI     │
│ Service │ │Price │  │ Service │ │ Print  │ │Repricing │
└────┬────┘ └──┬───┘  └────┬────┘ └───┬────┘ └────┬─────┘
     │         │           │          │           │
     │         │           │          │           │
     ▼         ▼           ▼          ▼           ▼
┌──────────────────────────────────────────────────────────┐
│              Core Services (Go Backend)                   │
│  Warehouse Management │ Inventory │ Analytics            │
└───────────────────────┬──────────────────────────────────┘
                        │
                        ▼
┌──────────────────────────────────────────────────────────┐
│              External Integrations                        │
│  Checkbox API │ Payment Providers │ Delivery Services    │
└──────────────────────────────────────────────────────────┘
```

## Модулі

### Фіскалізація (ПРРО)

**Призначення:** Інтеграція з українською системою фіскалізації через Checkbox API.

**Компоненти:**
- `lib/fiscal/prro-service.ts` - основний сервіс фіскалізації
- `lib/fiscal/checkbox-api.ts` - клієнт Checkbox API
- `lib/fiscal/types.ts` - типи даних
- `lib/fiscal/utils.ts` - допоміжні функції

**Основні функції:**
- Фіскалізація продажів (створення чеків)
- Фіскалізація повернень
- Управління касовими змінами
- Службові операції (внесення/винесення коштів)
- Генерація Z-звітів та X-звітів
- Отримання даних чеків (PDF, QR-код, текст)

**Схема роботи:**
```
Замовлення → Фіскалізація → Checkbox API → Фіскальний чек
    ↓              ↓              ↓              ↓
Збереження    Валідація     Реєстрація      PDF/QR
у БД          даних         у ДПС          для клієнта
```

**API Endpoints:**
- `POST /api/admin/fiscal/shift/open` - відкрити зміну
- `POST /api/admin/fiscal/shift/close` - закрити зміну
- `GET /api/admin/fiscal/shift/status` - статус зміни
- `POST /api/admin/fiscal/receipt` - створити чек
- `POST /api/admin/fiscal/return` - створити чек повернення
- `POST /api/admin/fiscal/service/deposit` - службове внесення
- `POST /api/admin/fiscal/service/withdraw` - службове винесення
- `GET /api/admin/fiscal/reports/daily` - денний звіт
- `GET /api/admin/fiscal/reports/period` - звіт за період

**Залежності:**
- Checkbox API (зовнішній сервіс)
- Дані замовлень з БД
- Email сервіс (відправка чеків)

---

### B2B Продажі

**Призначення:** Система оптових продажів з багаторівневими цінами.

**Компоненти:**
- `lib/b2b/pricing.ts` - сервіс ціноутворення
- `lib/b2b/price-list-generator.ts` - генератор прайс-листів
- `lib/b2b/credit.ts` - управління кредитними лімітами
- `lib/b2b/types.ts` - типи даних

**Рівні цін:**
1. **Retail** (Роздріб) - 0% знижка
2. **Small Wholesale** (Малий опт) - 10% знижка (від 5,000 грн, 10+ шт)
3. **Medium Wholesale** (Середній опт) - 15% знижка (від 20,000 грн, 50+ шт)
4. **Large Wholesale** (Великий опт) - 20% знижка (від 50,000 грн, 100+ шт)
5. **Partner** (Партнер) - 25% знижка (від 10,000 грн, 20+ шт)
6. **Distributor** (Дистриб'ютор) - 30% знижка (від 100,000 грн, 200+ шт)

**Функції:**
- Розрахунок цін за рівнями
- Індивідуальні ціни для клієнтів
- Знижки на категорії
- Розрахунок суми кошика з ПДВ
- Генерація прайс-листів (XLSX, CSV, XML)
- Кредитні ліміти та відстрочка платежу

**Схема ціноутворення:**
```
Базова ціна (Retail)
    ↓
Застосування знижки рівня
    ↓
Застосування індивідуальної ціни (якщо є)
    ↓
Застосування знижки на категорію
    ↓
Фінальна ціна для клієнта
```

**API Endpoints:**
- `GET /api/b2b/prices` - ціни для клієнта
- `GET /api/b2b/price-list` - прайс-лист
- `GET /api/b2b/credit` - кредитний ліміт
- `POST /api/b2b/order` - створити B2B замовлення
- `GET /api/b2b/orders` - історія замовлень
- `GET /api/b2b/invoices` - рахунки

**Залежності:**
- Дані товарів
- Дані клієнтів
- Система замовлень

---

### Dropshipping / Supplier API

**Призначення:** API для постачальників для автоматичного додавання товарів та управління замовленнями.

**Компоненти:**
- `lib/dropshipping/supplier-service.ts` - сервіс постачальників

**Функції:**
- Реєстрація постачальників
- Автентифікація через API ключ
- Управління товарами (CRUD)
- Оновлення залишків
- Отримання замовлень
- Підтвердження відправки
- Відстеження виплат
- Webhook-сповіщення

**Workflow постачальника:**
```
Реєстрація → Модерація адміном → Отримання API ключа
                                          ↓
                                 Додавання товарів
                                          ↓
                                  Синхронізація залишків
                                          ↓
                                 Отримання замовлень
                                          ↓
                                Підтвердження відправки
                                          ↓
                                    Виплата коштів
```

**API Endpoints:**
- `POST /api/supplier/register` - реєстрація
- `GET /api/supplier/products` - список товарів
- `POST /api/supplier/products` - додати товар
- `PUT /api/supplier/products/:id` - оновити товар
- `DELETE /api/supplier/products/:id` - видалити товар
- `POST /api/supplier/products/import` - масовий імпорт
- `GET /api/supplier/products/export` - експорт товарів
- `POST /api/supplier/stock` - оновити залишки
- `GET /api/supplier/orders` - отримати замовлення
- `POST /api/supplier/orders/:id/confirm` - підтвердити
- `POST /api/supplier/orders/:id/ship` - відправити
- `GET /api/supplier/earnings` - виплати
- `POST /api/supplier/payout` - запит на виплату
- `GET /api/supplier/profile` - профіль
- `POST /api/supplier/webhook` - webhook

**Комісія:**
- За замовчуванням: 15%
- Налаштовується індивідуально

**Залежності:**
- Система товарів
- Система замовлень
- Платіжна система

---

### Апаратне забезпечення

**Призначення:** Інтеграція з апаратним забезпеченням (принтери, сканери).

**Компоненти:**
- `lib/hardware/thermal-printer.ts` - термопринтери
- `lib/hardware/print-server.ts` - сервер друку
- `lib/hardware/datawedge.ts` - сканери DataWedge (Zebra)
- `lib/hardware/keyboard-wedge.ts` - сканери Keyboard Wedge

**Підтримувані пристрої:**
- Thermal принтери (ESC/POS)
- Принтери етикеток (ZPL, EPL)
- Сканери штрих-кодів (DataWedge, Keyboard Wedge)

**Функції:**
- Друк чеків
- Друк етикеток товарів
- Друк штрих-кодів
- Сканування штрих-кодів
- Налаштування принтерів

**Схема друку:**
```
Команда друку → Print Server → Принтер → Документ
    ↓               ↓             ↓
Черга          Форматування   USB/Network
завдань        ESC/POS, ZPL
```

**API Endpoints:**
- `GET /api/hardware/printers` - список принтерів
- `POST /api/hardware/printers` - додати принтер
- `GET /api/hardware/printers/:id` - інфо про принтер
- `PUT /api/hardware/printers/:id` - налаштувати
- `DELETE /api/hardware/printers/:id` - видалити
- `POST /api/hardware/print/label` - друк етикетки
- `POST /api/hardware/print/product-label` - друк етикетки товару
- `POST /api/hardware/print` - універсальний друк

**Залежності:**
- Драйвери принтерів
- USB/Network підключення

---

### AI Репрайсинг

**Призначення:** Автоматичне коригування цін на основі цін конкурентів.

**Компоненти:**
- `lib/ai/repricing-engine.ts` - движок репрайсингу
- `lib/ai/pricing-analytics.ts` - аналітика цін

**Стратегії репрайсингу:**
1. **Beat Lowest** - ціна нижче найнижчої на X грн
2. **Match Lowest** - відповідність найнижчій ціні
3. **Percentage Below** - X% нижче найнижчої
4. **Smart** - AI визначає оптимальну ціну для цільової позиції
5. **Maximize Margin** - максимізація маржі зі збереженням конкурентності

**Обмеження цін:**
- Мінімальна/максимальна ціна
- Мінімальна маржа
- Максимальна знижка
- Floor price (собівартість + мін. прибуток)
- Ceiling price (РРЦ)
- Округлення (0.99, 5, 10)

**Workflow:**
```
Збір цін конкурентів → Аналіз → Розрахунок оптимальної ціни
          ↓              ↓              ↓
    API/Scraping   Застосування    Валідація обмежень
                    стратегії             ↓
                                   Оновлення ціни
                                          ↓
                                   Історія змін
```

**API Endpoints:**
- `GET /api/ai/repricing` - правила репрайсингу
- `POST /api/ai/repricing` - створити правило
- `PUT /api/ai/repricing/:id` - оновити правило
- `DELETE /api/ai/repricing/:id` - видалити правило
- `POST /api/ai/repricing/run` - запустити репрайсинг
- `GET /api/ai/repricing/history` - історія змін цін
- `GET /api/ai/repricing/suggestions` - рекомендації
- `GET /api/ai/repricing/alerts` - цінові сповіщення

**Залежності:**
- Дані цін конкурентів (API/парсинг)
- Дані товарів
- Історія продажів

---

### AI Прогнозування попиту

**Призначення:** Прогнозування попиту на товари на основі історичних даних.

**Компоненти:**
- `lib/ai/demand-forecasting.ts` - прогнозування попиту

**Методи прогнозування:**
- Simple Moving Average (SMA)
- Exponential Smoothing
- Seasonal Decomposition
- Linear Regression
- ARIMA-подібні алгоритми

**Функції:**
- Прогноз продажів на N днів
- Виявлення сезонності
- Виявлення трендів
- Рекомендації щодо закупівель
- Симуляція різних сценаріїв

**Схема прогнозування:**
```
Історичні дані продажів
    ↓
Аналіз сезонності
    ↓
Виявлення трендів
    ↓
Застосування моделі
    ↓
Прогноз на N днів
    ↓
Рекомендації щодо закупівель
```

**API Endpoints:**
- `GET /api/ai/forecast` - прогноз для товару
- `GET /api/ai/forecast/seasonality` - сезонність
- `GET /api/ai/forecast/trends` - тренди
- `GET /api/ai/forecast/recommendations` - рекомендації
- `POST /api/ai/forecast/simulate` - симуляція сценаріїв

**Залежності:**
- Історія продажів
- Дані товарів
- Зовнішні фактори (сезонність, свята)

---

### Warehouse Management (Go)

**Призначення:** Розширене управління складом з додатковими функціями.

**Компоненти (Go):**
- `warehouse.go` - основний модуль
- `warehouse_map.go` - карта складу
- `tasks.go` - задачі складу
- `purchasing.go` - закупівлі
- `expiry.go` - терміни придатності
- `labels.go` - етикетування
- `packing.go` - пакування
- `quality_control.go` - контроль якості
- `returns.go` - повернення
- `cross_docking.go` - крос-докінг
- `kitting.go` - комплектація
- `split_shipment.go` - розділене відвантаження
- `advanced_features.go` - розширені функції

**Функції:**

**1. Карта складу (Warehouse Map):**
- Ієрархія: склад → зони → стелажі → полиці → комірки
- Візуалізація розміщення товарів
- Оптимізація маршрутів збирання

**2. Задачі складу (Tasks):**
- Приймання
- Розміщення
- Комплектація (Picking)
- Пакування
- Відвантаження
- Інвентаризація
- Переміщення
- Призначення виконавців
- Відстеження статусу

**3. Закупівлі (Purchasing):**
- Створення замовлень постачальникам
- Відстеження статусу закупівель
- Історія закупівель
- Автоматичні рекомендації закупівель

**4. Терміни придатності (Expiry):**
- Відстеження термінів придатності
- FEFO (First Expired, First Out)
- Сповіщення про наближення терміну
- Автоматичне списання прострочених товарів

**5. Етикетування (Labels):**
- Генерація штрих-кодів
- Друк етикеток товарів
- Етикетки місць зберігання
- Партійні етикетки

**6. Пакування (Packing):**
- Підбір упаковки
- Розрахунок об'єму
- Упаковочні листи
- Друк документів

**7. Контроль якості (Quality Control):**
- Перевірка при прийманні
- Вибіркова перевірка
- Дефекти та відхилення
- Карантин товарів

**8. Повернення (Returns):**
- Обробка повернень від клієнтів
- Оцінка стану товару
- Повернення на склад або списання
- RMA номери

**9. Крос-докінг (Cross-Docking):**
- Прямі поставки без зберігання
- Мінімізація часу зберігання
- Оптимізація вантажів

**10. Комплектація (Kitting):**
- Створення комплектів
- Розбирання комплектів
- Управління BOM (Bill of Materials)

**11. Розділене відвантаження (Split Shipment):**
- Розділення замовлення на кілька відправлень
- Різні склади
- Різні терміни відправки

**Інтеграція з Frontend:**
```
Next.js API Routes → gRPC/REST → Go Warehouse Service
        ↓                              ↓
   WebSocket для                  PostgreSQL
real-time оновлень                    БД
```

**Залежності:**
- PostgreSQL БД
- Redis (кешування)
- S3 (документи, етикетки)

---

## Інтеграційні точки

### Frontend ↔ API
- REST API (JSON)
- WebSocket (real-time оновлення)

### Next.js API ↔ Go Backend
- gRPC або REST
- Message Queue (RabbitMQ/Redis) для асинхронних операцій

### API ↔ External Services
- **Checkbox API** - фіскалізація
- **Payment Providers** - LiqPay, Monobank, ПриватБанк
- **Delivery Services** - Нова Пошта, Meest, Justin
- **Marketplaces** - Rozetka, Prom.ua
- **Competitor Price APIs** - для репрайсингу

### Database
- PostgreSQL - основна БД
- Redis - кешування, черги
- S3-compatible storage - файли, документи

---

## Залежності

### Node.js модулі (package.json)
```json
{
  "dependencies": {
    "next": "^15.0.0",
    "react": "^19.0.0",
    "typescript": "^5.3.0"
  }
}
```

### Go модулі (go.mod)
```go
require (
    github.com/lib/pq v1.10.9
    github.com/go-redis/redis/v8 v8.11.5
    google.golang.org/grpc v1.60.0
)
```

### Зовнішні сервіси
- Checkbox API - фіскалізація
- LiqPay API - оплата
- Monobank API - оплата
- Нова Пошта API - доставка
- SMTP сервер - email

---

## Безпека

### Автентифікація
- JWT токени для веб-клієнтів
- API ключі для постачальників
- HTTP-only cookies для токенів

### Авторизація
- Role-based access control (RBAC)
- Права доступу: admin, cashier, warehouse_worker, supplier, b2b_customer

### Валідація
- Валідація всіх вхідних даних
- Санітизація SQL запитів
- CSRF захист
- Rate limiting

### Аудит
- Логування всіх операцій
- Історія змін цін
- Історія фіскальних операцій
- Відстеження API викликів

---

## Масштабованість

### Горизонтальне масштабування
- Stateless API сервери
- Load balancer (nginx)
- Redis для розподіленого кешу
- Message queue для асинхронних задач

### Вертикальне масштабування
- Оптимізація запитів до БД
- Індекси БД
- Connection pooling
- Кешування частих запитів

### Моніторинг
- Prometheus метрики
- Datadog APM
- Sentry error tracking
- Structured logging

---

## Розробка та тестування

### Середовище розробки
```bash
# Frontend
npm run dev

# Go backend
go run cmd/server/main.go
```

### Тести
- Unit тести (Jest для TS, Go testing для Go)
- Integration тести
- E2E тести (Playwright)

### CI/CD
- GitHub Actions
- Автоматичні тести
- Deploy на staging/production

---

Створено: 2025-12-14
Версія: 1.0
